# 流式Markdown渲染系统 - 详细架构设计

## 1. 架构设计

### 1.1 整体架构
流式Markdown渲染系统采用分层架构设计，主要包含以下几个核心层：

1. **展示层**：负责最终渲染Markdown元素到UI
2. **解析层**：处理流式输入，解析各类Markdown标记
3. **状态管理层**：维护解析状态与元素树结构
4. **专项处理层**：处理特殊元素（如LaTeX公式、代码块等）

### 1.2 模块间交互关系

```
flowchart TD
    A[用户界面] --- B[MarkdownDisplayV2组件]
    C[输入源\nStream/String] -->|文本流| B
    B -->|解析请求| D[解析器\nMarkdownContentParser]
    D -->|解析结果| E[元素类型识别]
    E -->|元素类型| F[元素组件树]
    F -->|渲染| A
    B -->|管理| F
```

这种结构实现了清晰的职责分离，每个模块专注于自己的核心功能。

## 2. 核心数据处理流程

### 2.1 完整处理流程

```
flowchart TD
    A[流式输入数据\nStream<String>] --> B[解析器处理\n标记识别]
    B --> C[组件创建/更新\n状态管理]
    C --> D[界面渲染\n组件树更新]
```

### 2.2 详细处理步骤

#### 2.2.1 输入接收
- `markdown_display` 作为流数据的接收方，接收 `Stream<String>` 或完整 `String`
- 将接收到的数据传递给 `content_parser` 进行处理
- 处理不同输入源(完整文本/流式输入)的适配

#### 2.2.2 解析处理
- 解析器维护当前解析状态(`ParsingState`)
- 检测输入文本中的特殊标记(如`#`、`>`、` ``` `等)
- 根据当前状态和新输入更新解析状态
- 生成`ParsedMarkdownElement`流，传递给组件创建层

#### 2.2.3 组件创建与管理
- 根据解析结果创建或更新相应类型的组件
- 组件分为三种类型:
  * **文本处理组件**: 处理普通文本和内联样式(加粗、斜体等)，内部解析样式标记
  * **即时渲染组件**: 如分隔线、图片等，创建后即完成渲染
  * **容器组件**: 如代码块、LaTeX公式、引用等，需要持续接收内容直到遇到结束标记
- 管理组件状态，处理组件嵌套关系

#### 2.2.4 界面渲染
- 维护已创建组件的列表，根据组件状态更新UI
- 处理组件间的布局关系
- 仅重绘必要的部分，优化渲染性能
- 支持滚动位置管理和视图范围控制

### 2.3 特殊场景处理

#### 2.3.1 不完整标记处理
- 当接收到不完整标记时，保留在缓冲区等待后续输入
- 设置超时机制，超时后作为普通文本处理

#### 2.3.2 嵌套结构处理
- 使用栈结构管理嵌套组件(如列表中的代码块)
- 维护父子组件关系，确保正确渲染

#### 2.3.3 错误恢复机制
- 处理格式错误的输入，尽可能恢复正常渲染
- 提供降级渲染策略，确保UI不崩溃

#### 2.3.4 专项组件处理
- LaTeX公式: 调用专门的LaTeX解析器处理公式内容
- 代码块: 根据语言提供语法高亮
- 列表: 处理层级关系和不同类型列表

## 3. 关键算法实现

### 3.1 流式解析算法
```dart
Stream<ParsedMarkdownElement> parseStream(Stream<String> input) async* {
  await for (final chunk in input) {
    final elements = parseChunk(chunk);
    for (final element in elements) {
      yield element;
    }
  }
  
  // 处理最后可能的不完整内容
  if (_buffer.isNotEmpty) {
    final elements = _processBuffer();
    for (final element in elements) {
      yield element;
    }
  }
}
```

### 3.2 文本分割策略

#### 3.2.1 流式输入分割
- 按特殊标记分割
- 保持标记完整性
- 处理转义字符

#### 3.2.2 完整文本分割
- 按行分割
- 识别行内特殊标记
- 处理多行元素
- 生成标记流

## 4. 状态管理机制

### 4.1 解析状态机

解析器通过有限状态机(FSM)管理文本解析过程中的状态转换：

```
flowchart TD
    A[普通文本状态] -->|# 标记| B[标题状态]
    B -->|处理完成| A
    A -->|``` 标记| C[代码块状态]
    C -->|``` 标记| A
    A -->|> 标记| D[引用状态]
    D -->|处理完成| A
    A -->|\\[ 标记| E[块级公式状态]
    E -->|\\] 标记| A
    A -->|\\( 标记| F[行内公式状态]
    F -->|\\) 标记| A
    A -->|* - + 标记| G[列表状态]
    G -->|处理完成| A
```

状态机确保解析器能够正确处理不同类型的Markdown元素，并在适当的时候进行状态转换。

### 4.2 组件状态管理
每个组件负责管理自己的内部状态，包括：
- 文本内容
- 渲染状态
- 格式信息
- 缓冲区管理 