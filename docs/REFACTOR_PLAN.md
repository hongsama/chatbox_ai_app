# Markdown 解析重构计划（渐进式版本）

## 目标
创建一个模块化的 Markdown 解析系统，将不同类型的解析逻辑分离到专门的文件中，同时确保每一步重构后代码都能正常运行。

## 目录结构规划
```
lib/mathtest/
├── widgets/
│   └── markdown_display.dart
├── parsers/
│   ├── markdown_parser.dart      # 基础Markdown解析器
│   ├── latex_parser.dart         # 公式解析器
│   ├── code_parser.dart          # 代码解析器
│   └── document_parser.dart      # 主入口解析器（新增）
├── index.dart
├── latex_screen.dart
└── markdown_latex_parser.dart    # 过渡期保留
```

## 执行步骤

### 1. 创建基础结构（已完成）
- [✓] 创建 `parsers` 目录
- [✓] 创建三个新的解析器文件
- [✓] 在每个新文件中创建基础类结构
- [✓] 保持现有 `markdown_latex_parser.dart` 的功能不变
- [✓] 测试：确保现有功能正常工作

### 2. 实现公式解析器（已完成）
- [✓] 在 `latex_parser.dart` 中实现公式解析功能
- [✓] 保持与 `markdown_latex_parser.dart` 相同的接口
- [✓] 在 `markdown_latex_parser.dart` 中调用新的 `LatexParser`
- [✓] 测试：确保公式解析功能正常工作

### 3. 实现代码解析器（已完成）
- [✓] 在 `code_parser.dart` 中实现代码解析功能
- [✓] 从 `markdown_display.dart` 迁移代码解析逻辑
- [✓] 在 `markdown_display.dart` 中调用新的 `CodeParser`
- [✓] 测试：确保代码块显示功能正常工作
- [✓] 优化代码块实时渲染逻辑

### 4. 实现主解析器并启用（当前阶段）
- [✓] 在 `markdown_parser.dart` 中实现基本解析功能
  - [✓] 实现标题解析
  - [✓] 实现引用解析
  - [✓] 实现列表解析
  - [✓] 实现粗体和斜体解析
  - [✓] 完善错误处理
  - [✓] 添加必要的测试用例
- [✓] 修改 `markdown_latex_parser.dart` 使用新解析器
  - [✓] 将现有的基础 Markdown 解析替换为 `MarkdownParser`
  - [✓] 保持 LaTeX 和代码块的现有处理方式
  - [✓] 确保解析结果的一致性
- [✓] 运行和测试
  - [✓] 验证所有基础 Markdown 语法都通过 `MarkdownParser` 处理
  - [✓] 确保与 LaTeX 和代码块解析不冲突
  - [✓] 对比新旧解析结果

### 5. 实现统一入口（后续阶段）
- [ ] 创建 `document_parser.dart`
  - [ ] 定义清晰的解析流程
  - [ ] 实现解析器的优先级机制
  - [ ] 处理解析器之间的冲突
- [ ] 整合现有解析器
  - [ ] 集成 `MarkdownParser` 处理基础语法
  - [ ] 集成 `LatexParser` 处理公式
  - [ ] 集成 `CodeParser` 处理代码块
- [ ] 实现解析状态管理
  - [ ] 跟踪已处理的内容
  - [ ] 防止重复处理
  - [ ] 优化性能
- [ ] 测试新的解析系统

### 6. 重构显示组件
- [ ] 更新 `markdown_display.dart` 使用新的解析器系统
  - [ ] 移除旧的解析逻辑
  - [ ] 使用 `DocumentParser` 进行解析
  - [ ] 优化渲染逻辑
- [ ] 测试：确保显示效果与之前一致

### 7. 清理和优化
- [ ] 确认所有功能都迁移完成
- [ ] 删除 `markdown_latex_parser.dart`
- [ ] 优化代码结构
- [ ] 添加单元测试
- [ ] 进行集成测试

## 当前进展
1. 完成了基础结构的创建
2. 完成了公式解析器的实现和迁移
3. 完成了代码解析器的实现和迁移
4. 完成了代码块实时渲染的优化
5. 开始实现主解析器并准备替换现有解析逻辑
6. 下一步：完成主解析器并验证其在实际运行中的效果

## 关键策略

1. **解析器替换策略**：
   - 完成主解析器后立即在现有系统中启用
   - 保持 LaTeX 和代码块的现有处理方式不变
   - 通过实际运行验证解析效果

2. **状态管理**：
   - 确保新旧解析器的平滑切换
   - 避免解析冲突
   - 保持处理结果的一致性

3. **错误处理**：
   - 每个解析器独立处理自己的错误
   - 主入口统一处理全局错误
   - 提供清晰的错误信息

4. **性能优化**：
   - 避免不必要的重复解析
   - 实现缓存机制
   - 优化解析器切换逻辑

## 注意事项
1. 每一步都要确保代码可运行
2. 保持现有功能不变
3. 逐步迁移，不急于删除旧代码
4. 充分测试每个步骤
5. 准备好回滚机制
6. 保持版本控制 