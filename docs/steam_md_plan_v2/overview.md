# 流式Markdown渲染系统 - 概述

## 1. 项目背景和目标

当前应用中的Markdown渲染模块无法支持流式输入处理，导致在与AI对话等场景中，无法实时渲染AI正在生成的内容。需要开发一套全新的流式Markdown渲染系统，以支持流式文本输入的实时解析与渲染。

## 2. 核心需求和挑战

### 2.1 核心需求
1. **流式输入处理**：支持逐字符/分片接收文本并实时解析
2. **Markdown元素实时渲染**：文本输入时，各类元素能够动态渲染，支持元素的状态变化
3. **支持LaTeX数学公式**：同时支持行内和块级LaTeX公式渲染
4. **高性能渲染**：优化渲染性能，减少重绘范围，支持大文档平滑渲染
5. **组件复用**：最大化复用现有组件和逻辑
6. **健壮性**：处理不完整、错误或特殊格式的输入，保证应用稳定性

### 2.2 关键技术挑战
1. 如何处理分片输入中的不完整Markdown元素
2. 如何平衡实时解析性能与渲染质量
3. 解析状态管理与元素树的动态更新
4. 嵌套结构（如列表中的代码块）的正确处理
5. 确保不同类型Markdown元素的正确渲染顺序

## 3. 整体架构图

### 3.1 系统层级结构
流式Markdown渲染系统采用分层架构设计，主要包含以下几个核心层：

1. **展示层**：负责最终渲染Markdown元素到UI
2. **解析层**：处理流式输入，解析各类Markdown标记
3. **状态管理层**：维护解析状态与元素树结构
4. **专项处理层**：处理特殊元素（如LaTeX公式、代码块等）

### 3.2 模块间交互关系

```
flowchart TD
    A[用户界面] --- B[MarkdownDisplayV2组件]
    C[输入源\nStream/String] -->|文本流| B
    B -->|解析请求| D[解析器\nMarkdownContentParser]
    D -->|解析结果| E[元素类型识别]
    E -->|元素类型| F[元素组件树]
    F -->|渲染| A
    B -->|管理| F
    B -->|创建持有| G[MarkdownTheme]
    F -->|获取样式\n注册回调| G
    H[主题更新] -->|通知| G
    G -->|触发回调| F
```

## 4. 核心数据流程

### 4.1 数据处理流程

```
flowchart TD
    A[流式输入数据\nStream<String>] --> B[解析器处理\n标记识别]
    B --> C[组件创建/更新\n状态管理]
    C --> D[界面渲染\n组件树更新]
    E[主题系统] -->|样式更新| D
```

### 4.2 组件处理流程

```
flowchart LR
    A[MarkdownDisplayV2] -->|appendText| B[BaseMarkdownElement子类]
    B -->|setState| C[更新UI]
    A -->|提供主题| D[MarkdownTheme]
    B -->|获取样式\n注册回调| D
    D -->|主题变更通知| B
```

### 4.3 数据流转机制
MarkdownDisplayV2组件接收流式文本输入，通过调用对应元素组件的`appendText`方法将文本传递给组件。元素组件接收到文本后，根据自身状态和类型处理文本，并通过`setState`触发界面更新。

### 4.4 主题管理机制
- Display创建并持有MarkdownTheme实例
- 元素组件从所属Display获取主题引用并注册回调
- 主题系统使用元素类型枚举(MarkdownElementType)实现类型安全的主题映射
- 各元素主题提供getter/setter访问样式属性，setter触发注册组件更新
- 主题更新支持三种方式：直接属性修改、批量更新和整体切换

### 4.5 设计优势
1. **简单的接口**：只需一个`appendText`方法处理文本流
2. **统一的处理模式**：所有元素遵循相同的接收-处理-渲染流程
3. **状态封装**：每个元素组件负责管理自己的状态
4. **类型安全**：主题系统通过枚举和泛型确保类型匹配
5. **所有权明确**：Display创建和持有主题，避免全局单例的问题
6. **自顶向下数据流**：符合Flutter的设计理念，数据从父组件向下传递
7. **易于扩展**：添加新元素只需继承基类并实现必要方法

---

## 相关文档

- [组件设计](./components.md) - 组件分类与设计原则
- [API文档](./api.md) - 接口定义和使用方法
- [实现计划](./implementation.md) - 数据处理流程和算法实现
- [项目规划](./project.md) - 项目结构和进度跟踪 